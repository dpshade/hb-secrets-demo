<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Single Message Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .messages { 
            border: 1px solid #ccc; 
            padding: 20px; 
            margin: 20px 0; 
            height: 300px; 
            overflow-y: auto;
            background: #f9f9f9;
        }
        .message { 
            margin: 10px 0; 
            padding: 8px;
            background: white;
            border-radius: 4px;
            transition: opacity 0.3s ease;
        }
        .message.pending { 
            opacity: 0.6; 
            background: #fff3cd;
            position: relative;
        }
        .message.pending::after {
            content: '⏳';
            position: absolute;
            right: 8px;
            top: 8px;
        }
        .message.confirmed { 
            opacity: 1; 
            background: #d4edda;
        }
        .message.own-message .username { color: #f66700; font-weight: bold; }
        .controls { margin: 20px 0; }
        button { padding: 8px 16px; margin-right: 10px; }
        input { padding: 8px; width: 300px; }
    </style>
</head>
<body>
    <h1>Single Message System Test</h1>
    
    <div class="controls">
        <input type="text" id="messageInput" placeholder="Enter test message" />
        <button onclick="sendMessage()">Send Message</button>
        <button onclick="simulateConfirmation()">Simulate Confirmation</button>
        <button onclick="clearMessages()">Clear</button>
    </div>
    
    <div class="messages" id="messages"></div>
    
    <div id="log" style="background: #f0f0f0; padding: 10px; font-family: monospace; font-size: 12px;"></div>

    <script>
        let messageId = 0;
        let messages = [];
        let sentMessageHashes = new Map();
        
        function log(msg) {
            const logEl = document.getElementById('log');
            logEl.innerHTML += new Date().toISOString() + ': ' + msg + '<br>';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }
        
        function createMessageHash(content, author) {
            return `${content.trim()}::${author.trim()}`;
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;
            
            messageId++;
            const username = 'TestUser';
            const message = {
                id: messageId,
                content: content,
                timestamp: Date.now(),
                author: username,
                status: 'pending',
                method: 'direct-push',
                isPending: true
            };
            
            // Create hash for deduplication
            const messageHash = createMessageHash(content, username);
            sentMessageHashes.set(messageHash, messageId);
            
            messages.push(message);
            renderMessages();
            
            log(`Sent message ${messageId}: "${content}" (pending)`);
            
            // Auto-confirm after timeout (simulate if no manual confirmation)
            setTimeout(() => {
                const stillPending = messages.find(m => m.id === messageId && m.isPending);
                if (stillPending) {
                    log(`Auto-confirming message ${messageId} after timeout`);
                    confirmMessage(messageId);
                    sentMessageHashes.delete(messageHash);
                }
            }, 5000);
            
            input.value = '';
        }
        
        function simulateConfirmation() {
            // Find the most recent pending message
            const pendingMessage = messages.reverse().find(m => m.isPending);
            messages.reverse();
            
            if (pendingMessage) {
                // Simulate receiving the same message from history
                const messageHash = createMessageHash(pendingMessage.content, pendingMessage.author);
                const existingMessageId = sentMessageHashes.get(messageHash);
                
                if (existingMessageId) {
                    log(`Confirming message ${existingMessageId} via history simulation`);
                    confirmMessage(existingMessageId);
                    sentMessageHashes.delete(messageHash);
                } else {
                    log('No pending message hash found for confirmation');
                }
            } else {
                log('No pending messages to confirm');
            }
        }
        
        function confirmMessage(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (message) {
                message.status = 'confirmed';
                message.isPending = false;
                renderMessages();
                log(`Message ${messageId} confirmed`);
            }
        }
        
        function renderMessages() {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            
            messages.forEach(message => {
                const messageEl = document.createElement('div');
                messageEl.className = 'message';
                
                if (message.isPending || message.status === 'pending') {
                    messageEl.classList.add('pending');
                } else if (message.status === 'confirmed') {
                    messageEl.classList.add('confirmed');
                }
                
                if (message.method === 'direct-push') {
                    messageEl.classList.add('own-message');
                }
                
                const timestamp = new Date(message.timestamp).toLocaleTimeString();
                messageEl.innerHTML = `
                    <span class="username">${message.author}</span> • 
                    <span class="timestamp">${timestamp}</span>: 
                    <span class="content">${message.content}</span>
                    <small style="float: right; color: #666;">[${message.status}]</small>
                `;
                
                container.appendChild(messageEl);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        function clearMessages() {
            messages = [];
            sentMessageHashes.clear();
            renderMessages();
            log('Messages cleared');
        }
        
        log('Single message test system initialized');
    </script>
</body>
</html>